---
chunk_index: 1068
ref: "1d37478add3b"
id: "1d37478add3be37bfa51621fa10cdb0398edd936d41676d1cb0c840fd42df7d0"
slug: "chunk-l578-636"
path: "/home/zack/dev/llmx/ingestor-core/src/chunk.rs"
kind: "text"
lines: [578, 636]
token_estimate: 401
content_sha256: "ee8a0181b1208bd60d93fb52a28b550866348537f716810674ebbe4f9d547bd2"
compacted: false
heading_path: []
symbol: null
address: null
asset_path: null
---

let raw_context = if let Some(last) = heading_path.last() {
        Some(last.as_str())
    } else if let Some(symbol) = symbol {
        Some(symbol.as_str())
    } else {
        address.as_ref().map(|address| address.as_str())
    };

    let context_slug = raw_context
        .map(slugify)
        .map(|ctx| strip_redundant_prefix(&ctx, &base_slug))
        .map(|ctx| truncate_slug(&ctx, 44))
        .filter(|ctx| !ctx.is_empty() && ctx != "chunk" && *ctx != base_slug);

    let mut slug = match context_slug {
        Some(ctx) => format!("{}--{}", base_slug, ctx),
        None => base_slug,
    };
    if kind == ChunkKind::Text {
        slug = format!("{}-l{}-{}", slug, start_line, end_line);
    }
    truncate_slug(&slug, 96)
}

fn strip_extension(name: &str) -> &str {
    match name.rsplit_once('.') {
        Some((stem, _ext)) if !stem.is_empty() => stem,
        _ => name,
    }
}

fn truncate_slug(input: &str, max_len: usize) -> String {
    let mut out = if input.len() <= max_len {
        input.to_string()
    } else {
        input.chars().take(max_len).collect()
    };
    while out.ends_with('-') {
        out.pop();
    }
    while out.starts_with('-') {
        out.remove(0);
    }
    out
}

fn strip_redundant_prefix(context: &str, base: &str) -> String {
    let mut ctx = context.to_string();
    let mut changed = true;
    while changed {
        changed = false;
        if let Some(rest) = ctx.strip_prefix(base) {
            let rest = rest.trim_start_matches('-');
            ctx = rest.to_string();
            changed = true;
        }
    }
    ctx
}