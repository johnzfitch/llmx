---
chunk_index: 1192
ref: "1ffb2ce895d9"
id: "1ffb2ce895d952b975867468e99e217d1ccbb74303623dfda4263d7d54ddc753"
slug: "handler-tests-l1-157"
path: "/home/zack/dev/llmx/ingestor-core/tests/handler_tests.rs"
kind: "text"
lines: [1, 157]
token_estimate: 1017
content_sha256: "75d6cca2dfa5f6ff563a6dad113256afda93be54b6552190a0a5dd012586ccdb"
compacted: false
heading_path: []
symbol: null
address: null
asset_path: null
---

//! Handler unit tests - tests handler functions directly without CLI overhead.
//!
//! These tests verify the core business logic of llmx handlers.
//!
//! Run with: cargo test --features cli --test handler_tests

#![cfg(feature = "cli")]

mod common;

use ingestor_core::handlers::{
    llmx_explore_handler, llmx_get_chunk_handler, llmx_index_handler, llmx_manage_handler,
    llmx_search_handler, ExploreInput, IndexInput, IndexStore, IngestOptionsInput, ManageInput,
    SearchFiltersInput, SearchInput,
};
use tempfile::TempDir;

/// Create a fresh IndexStore with temp directory.
fn create_store() -> (TempDir, IndexStore) {
    let temp = TempDir::new().expect("Failed to create temp dir");
    let store = IndexStore::new(temp.path().to_path_buf()).expect("Failed to create store");
    (temp, store)
}

/// Create a test project with sample files.
fn create_test_project() -> TempDir {
    use std::fs;

    let temp = TempDir::new().expect("Failed to create temp dir");

    // Create source files
    fs::create_dir_all(temp.path().join("src")).unwrap();

    fs::write(
        temp.path().join("src/main.rs"),
        r#"//! Main entry point
fn main() {
    println!("Hello, world!");
}
"#,
    )
    .unwrap();

    fs::write(
        temp.path().join("src/lib.rs"),
        r#"//! Library module

/// A greeting function.
pub fn greet(name: &str) -> String {
    format!("Hello, {}!", name)
}

/// Calculate fibonacci number.
pub fn fibonacci(n: u32) -> u32 {
    match n {
        0 => 0,
        1 => 1,
        _ => fibonacci(n - 1) + fibonacci(n - 2),
    }
}
"#,
    )
    .unwrap();

    fs::write(
        temp.path().join("README.md"),
        r#"# Test Project

A simple test project.

## Usage

```rust
use test_project::greet;
println!("{}", greet("World"));
```
"#,
    )
    .unwrap();

    fs::write(
        temp.path().join("config.json"),
        r#"{
    "name": "test-project",
    "version": "1.0.0"
}
"#,
    )
    .unwrap();

    temp
}

// ============================================================================
// Index Handler Tests
// ============================================================================

#[test]
fn test_handler_index_creates_new_index() {
    let (_storage, mut store) = create_store();
    let project = create_test_project();

    let input = IndexInput {
        paths: vec![project.path().to_string_lossy().to_string()],
        options: None,
    };

    let output = llmx_index_handler(&mut store, input).expect("Index should succeed");

    assert!(output.created, "Should create new index");
    assert!(!output.index_id.is_empty(), "Should have index ID");
    assert!(output.stats.total_files > 0, "Should have files");
    assert!(output.stats.total_chunks > 0, "Should have chunks");
}

#[test]
fn test_handler_index_updates_existing() {
    let (_storage, mut store) = create_store();
    let project = create_test_project();

    let path = project.path().to_string_lossy().to_string();

    // First index
    let input1 = IndexInput {
        paths: vec![path.clone()],
        options: None,
    };
    let first = llmx_index_handler(&mut store, input1).expect("First index should succeed");
    assert!(first.created);

    // Second index (update)
    let input2 = IndexInput {
        paths: vec![path],
        options: None,
    };
    let second = llmx_index_handler(&mut store, input2).expect("Second index should succeed");
    assert!(!second.created, "Should update, not create");
    assert_eq!(first.index_id, second.index_id, "Should have same ID");
}

#[test]
fn test_handler_index_with_custom_options() {
    let (_storage, mut store) = create_store();
    let project = create_test_project();

    let input = IndexInput {
        paths: vec![project.path().to_string_lossy().to_string()],
        options: Some(IngestOptionsInput {
            chunk_target_chars: Some(1000),
            max_file_bytes: Some(1024 * 1024),
        }),
    };

    let output = llmx_index_handler(&mut store, input).expect("Index should succeed");
    assert!(output.created);
}