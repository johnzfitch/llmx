---
chunk_index: 1207
ref: "9c528115f7dd"
id: "9c528115f7dd5b0bd3bb4b8bd77b5c4ed63e1ddc87233a6fab073e885aa12708"
slug: "token-savings-tests-l1-132"
path: "/home/zack/dev/llmx/ingestor-core/tests/token_savings_tests.rs"
kind: "text"
lines: [1, 132]
token_estimate: 1068
content_sha256: "a5f099a198ad20e03b77721fdceadbda5d87ed29fa7911e88187ca1423b3b612"
compacted: false
heading_path: []
symbol: null
address: null
asset_path: null
---

//! Token savings analysis tests - measure and verify token reduction claims.
//!
//! These tests verify that llmx delivers on its promise of 80-95% token savings
//! compared to reading raw files.
//!
//! Run with: cargo test --features cli --test token_savings_tests

#![cfg(feature = "cli")]

mod common;

use common::{calculate_raw_tokens, estimate_tokens};
use ingestor_core::handlers::{
    llmx_index_handler, llmx_search_handler, IndexInput, IndexStore, SearchInput,
};
use ingestor_core::export_llm;
use std::fs;
use tempfile::TempDir;

/// Create an IndexStore with temp directory.
fn create_store() -> (TempDir, IndexStore) {
    let temp = TempDir::new().expect("Failed to create temp dir");
    let store = IndexStore::new(temp.path().to_path_buf()).expect("Failed to create store");
    (temp, store)
}

/// Token savings report.
#[derive(Debug)]
struct TokenSavingsReport {
    raw_tokens: usize,
    manifest_tokens: usize,
    search_result_tokens: usize,
    manifest_savings_pct: f64,
    search_savings_pct: f64,
}

impl TokenSavingsReport {
    fn new(raw: usize, manifest: usize, search: usize) -> Self {
        let manifest_savings = if raw > 0 {
            ((raw - manifest) as f64 / raw as f64) * 100.0
        } else {
            0.0
        };
        let search_savings = if raw > 0 {
            ((raw - search) as f64 / raw as f64) * 100.0
        } else {
            0.0
        };
        TokenSavingsReport {
            raw_tokens: raw,
            manifest_tokens: manifest,
            search_result_tokens: search,
            manifest_savings_pct: manifest_savings,
            search_savings_pct: search_savings,
        }
    }
}

// ============================================================================
// Simple Codebase Tests (10 files, ~5KB each)
// ============================================================================

#[test]
fn test_token_savings_simple_codebase() {
    let (_storage, mut store) = create_store();
    let project = TempDir::new().unwrap();

    // Create 10 files of ~5KB each
    for i in 0..10 {
        let content = format!(
            "// File {}\n\n{}\n",
            i,
            "fn function_name() {\n    let x = 42;\n    println!(\"Value: {}\", x);\n}\n".repeat(50)
        );
        fs::write(project.path().join(format!("file{}.rs", i)), &content).unwrap();
    }

    // Calculate raw tokens
    let raw_tokens = calculate_raw_tokens(project.path());

    // Index
    let idx_input = IndexInput {
        paths: vec![project.path().to_string_lossy().to_string()],
        options: None,
    };
    let idx_output = llmx_index_handler(&mut store, idx_input).unwrap();

    // Get manifest tokens
    let index = store.load(&idx_output.index_id).unwrap();
    let manifest = export_llm(index);
    let manifest_tokens = estimate_tokens(&manifest);

    // Search and get result tokens
    let search_input = SearchInput {
        index_id: idx_output.index_id.clone(),
        query: "function".to_string(),
        filters: None,
        limit: Some(5),
        max_tokens: Some(4000),
        use_semantic: None,
    };
    let search_output = llmx_search_handler(&mut store, search_input).unwrap();
    let search_tokens: usize = search_output
        .results
        .iter()
        .map(|r| estimate_tokens(&r.content))
        .sum();

    let report = TokenSavingsReport::new(raw_tokens, manifest_tokens, search_tokens);

    println!("Simple codebase token savings:");
    println!("  Raw tokens: {}", report.raw_tokens);
    println!("  Manifest tokens: {}", report.manifest_tokens);
    println!("  Search result tokens: {}", report.search_result_tokens);
    println!("  Manifest savings: {:.1}%", report.manifest_savings_pct);
    println!("  Search savings: {:.1}%", report.search_savings_pct);

    // Verify manifest is smaller than raw
    assert!(
        report.manifest_savings_pct >= 0.0,
        "Manifest should provide some token reduction"
    );

    // Verify search provides meaningful savings over raw
    // Note: Savings depend on query specificity and content distribution
    assert!(
        report.search_savings_pct >= 50.0,
        "Search should provide at least 50% savings, got {:.1}%",
        report.search_savings_pct
    );
}