---
chunk_index: 1336
ref: "ed69e1c7975a"
id: "ed69e1c7975a048e891066c18b7addf3f9dd5c073e9ca83d9f1d149f2cf17d8a"
slug: "app--collectfilesfromhandle"
path: "/home/zack/dev/llmx/web/app.js"
kind: "java_script"
lines: [298, 331]
token_estimate: 259
content_sha256: "758374b7d7005a038bdecc950d71dce3cecf28653df5bc9e8ce36e8c2bb9ac06"
compacted: false
heading_path: []
symbol: "collectFilesFromHandle"
address: null
asset_path: null
---

async function collectFilesFromHandle(handle, basePath = "", budget = null) {
  const entries = [];
  const shared = budget || {
    totalBytes: 0,
    skippedLarge: 0,
    skippedTotal: 0,
  };
  for await (const [name, entry] of handle.entries()) {
    if (entry.kind === "directory") {
      if (SKIP_DIRS.includes(name)) {
        continue;
      }
      const nested = await collectFilesFromHandle(entry, `${basePath}${name}/`, shared);
      entries.push(...nested.entries);
      continue;
    }
    const path = `${basePath}${name}`;
    if (!isAllowedPath(path)) {
      continue;
    }
    const file = await entry.getFile();
    if (file.size > DEFAULT_LIMITS.maxFileBytes) {
      shared.skippedLarge += 1;
      continue;
    }
    if (shared.totalBytes + file.size > DEFAULT_LIMITS.maxTotalBytes) {
      shared.skippedTotal += 1;
      continue;
    }
    entries.push({ path, file });
    shared.totalBytes += file.size;
  }
  return { entries, skippedLarge: shared.skippedLarge, skippedTotal: shared.skippedTotal };
}