---
chunk_index: 1098
ref: "ca7b0cb6708f"
id: "ca7b0cb6708f9b40e1975a28feb33d7429707b4ea25688ef47bb851559e77232"
slug: "cli-tests-l508-670"
path: "/home/zack/dev/llmx/ingestor-core/tests/cli_tests.rs"
kind: "text"
lines: [508, 670]
token_estimate: 1048
content_sha256: "3c7fe6321ad3e4fd9f4f550d9ae897de66a16ed4d81fdf693ab300bab8932e47"
compacted: false
heading_path: []
symbol: null
address: null
asset_path: null
---

// Verify it's gone
    llmx()
        .args(["list", "--storage-dir", storage.path().to_str().unwrap()])
        .assert()
        .success()
        .stdout(predicate::str::contains("No indexes found"));
}

// ============================================================================
// Export Command Tests
// ============================================================================

#[test]
fn test_cli_export_llm_md() {
    let storage = TempDir::new().unwrap();
    let project = create_test_project();

    llmx()
        .args([
            "index",
            project.path().to_str().unwrap(),
            "--storage-dir",
            storage.path().to_str().unwrap(),
        ])
        .assert()
        .success();

    llmx()
        .args([
            "export",
            "--format",
            "llm.md",
            "--storage-dir",
            storage.path().to_str().unwrap(),
        ])
        .current_dir(project.path())
        .assert()
        .success()
        .stdout(predicate::str::contains("#"));
}

#[test]
fn test_cli_export_zip() {
    let storage = TempDir::new().unwrap();
    let project = create_test_project();
    let output_dir = TempDir::new().unwrap();

    llmx()
        .args([
            "index",
            project.path().to_str().unwrap(),
            "--storage-dir",
            storage.path().to_str().unwrap(),
        ])
        .assert()
        .success();

    let zip_path = output_dir.path().join("export.zip");
    llmx()
        .args([
            "export",
            "--format",
            "zip",
            "--output",
            zip_path.to_str().unwrap(),
            "--storage-dir",
            storage.path().to_str().unwrap(),
        ])
        .current_dir(project.path())
        .assert()
        .success()
        .stdout(predicate::str::contains("Exported zip"));

    assert!(zip_path.exists(), "Zip file should exist");
    assert!(
        fs::metadata(&zip_path).unwrap().len() > 0,
        "Zip file should not be empty"
    );
}

#[test]
fn test_cli_export_json() {
    let storage = TempDir::new().unwrap();
    let project = create_test_project();

    llmx()
        .args([
            "index",
            project.path().to_str().unwrap(),
            "--storage-dir",
            storage.path().to_str().unwrap(),
        ])
        .assert()
        .success();

    llmx()
        .args([
            "export",
            "--format",
            "json",
            "--storage-dir",
            storage.path().to_str().unwrap(),
        ])
        .current_dir(project.path())
        .assert()
        .success()
        .stdout(predicate::str::contains("{"))
        .stdout(predicate::str::contains("\"index_id\""));
}

// ============================================================================
// Get Command Tests
// ============================================================================

#[test]
fn test_cli_get_chunk() {
    let storage = TempDir::new().unwrap();
    let project = create_test_project();

    // Index
    llmx()
        .args([
            "index",
            project.path().to_str().unwrap(),
            "--storage-dir",
            storage.path().to_str().unwrap(),
        ])
        .assert()
        .success();

    // Get chunk ID from search
    let output = llmx()
        .args([
            "search",
            "fn",
            "--json",
            "--storage-dir",
            storage.path().to_str().unwrap(),
        ])
        .current_dir(project.path())
        .assert()
        .success();

    let stdout = String::from_utf8_lossy(&output.get_output().stdout);
    let json: serde_json::Value = serde_json::from_str(&stdout).unwrap();

    if let Some(first_result) = json["results"].as_array().and_then(|a| a.first()) {
        let chunk_id = first_result["chunk_id"].as_str().unwrap();

        llmx()
            .args([
                "get",
                chunk_id,
                "--storage-dir",
                storage.path().to_str().unwrap(),
            ])
            .current_dir(project.path())
            .assert()
            .success()
            .stdout(predicate::str::contains(".rs:"));
    }
}