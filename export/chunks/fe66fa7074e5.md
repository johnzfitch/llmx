---
chunk_index: 1201
ref: "fe66fa7074e5"
id: "fe66fa7074e5c4ea68d21dc16bfeea67b7f6989039881b2e58d358c5f31718a7"
slug: "mcp-tests-l1-125"
path: "/home/zack/dev/llmx/ingestor-core/tests/mcp_tests.rs"
kind: "text"
lines: [1, 125]
token_estimate: 1031
content_sha256: "e04719a5038a23842d3fce7d3245acf4c745fd23fc1d2ab38f4e850417a2e3a5"
compacted: false
heading_path: []
symbol: null
address: null
asset_path: null
---

//! MCP protocol tests - verify MCP type definitions and conversions.
//!
//! These tests ensure MCP input types deserialize correctly and convert
//! properly to handler types.
//!
//! Run with: cargo test --features mcp --test mcp_tests

#![cfg(feature = "mcp")]

use ingestor_core::mcp::tools::{
    ExploreInputMcp, IndexInputMcp, IngestOptionsInputMcp, ManageInputMcp,
    SearchFiltersInputMcp, SearchInputMcp,
};

// ============================================================================
// Index Input Deserialization
// ============================================================================

#[test]
fn test_mcp_index_input_minimal() {
    let json = r#"{"paths": ["/path/to/project"]}"#;
    let input: IndexInputMcp = serde_json::from_str(json).expect("Should deserialize");

    assert_eq!(input.paths, vec!["/path/to/project"]);
    assert!(input.options.is_none());
}

#[test]
fn test_mcp_index_input_with_options() {
    let json = r#"{
        "paths": ["/path/to/project"],
        "options": {
            "chunk_target_chars": 2000,
            "max_file_bytes": 5000000
        }
    }"#;
    let input: IndexInputMcp = serde_json::from_str(json).expect("Should deserialize");

    assert_eq!(input.paths, vec!["/path/to/project"]);
    let options = input.options.expect("Should have options");
    assert_eq!(options.chunk_target_chars, Some(2000));
    assert_eq!(options.max_file_bytes, Some(5000000));
}

#[test]
fn test_mcp_index_input_multiple_paths() {
    let json = r#"{"paths": ["/path/one", "/path/two", "/path/three"]}"#;
    let input: IndexInputMcp = serde_json::from_str(json).expect("Should deserialize");

    assert_eq!(input.paths.len(), 3);
}

// ============================================================================
// Search Input Deserialization
// ============================================================================

#[test]
fn test_mcp_search_input_minimal() {
    let json = r#"{
        "index_id": "abc123",
        "query": "test query"
    }"#;
    let input: SearchInputMcp = serde_json::from_str(json).expect("Should deserialize");

    assert_eq!(input.index_id, "abc123");
    assert_eq!(input.query, "test query");
    assert!(input.filters.is_none());
    assert!(input.limit.is_none());
    assert!(input.max_tokens.is_none());
}

#[test]
fn test_mcp_search_input_with_all_options() {
    let json = r#"{
        "index_id": "abc123",
        "query": "function",
        "filters": {
            "path_prefix": "src/",
            "kind": "javascript"
        },
        "limit": 20,
        "max_tokens": 8000,
        "use_semantic": true
    }"#;
    let input: SearchInputMcp = serde_json::from_str(json).expect("Should deserialize");

    assert_eq!(input.index_id, "abc123");
    assert_eq!(input.query, "function");
    assert_eq!(input.limit, Some(20));
    assert_eq!(input.max_tokens, Some(8000));
    assert_eq!(input.use_semantic, Some(true));

    let filters = input.filters.expect("Should have filters");
    assert_eq!(filters.path_prefix, Some("src/".to_string()));
    assert_eq!(filters.kind, Some("javascript".to_string()));
}

#[test]
fn test_mcp_search_filters_all_fields() {
    let json = r###"{
        "path_prefix": "src/api",
        "kind": "markdown",
        "symbol_prefix": "User",
        "heading_prefix": "## API"
    }"###;
    let filters: SearchFiltersInputMcp = serde_json::from_str(json).expect("Should deserialize");

    assert_eq!(filters.path_prefix, Some("src/api".to_string()));
    assert_eq!(filters.kind, Some("markdown".to_string()));
    assert_eq!(filters.symbol_prefix, Some("User".to_string()));
    assert_eq!(filters.heading_prefix, Some("## API".to_string()));
}

// ============================================================================
// Explore Input Deserialization
// ============================================================================

#[test]
fn test_mcp_explore_input_files_mode() {
    let json = r#"{
        "index_id": "abc123",
        "mode": "files"
    }"#;
    let input: ExploreInputMcp = serde_json::from_str(json).expect("Should deserialize");