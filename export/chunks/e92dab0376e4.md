---
chunk_index: 1095
ref: "e92dab0376e4"
id: "e92dab0376e4aa491bba1b02afff0ca0a27dcaebbe1b64259550d808ac56a142"
slug: "cli-tests-l1-165"
path: "/home/zack/dev/llmx/ingestor-core/tests/cli_tests.rs"
kind: "text"
lines: [1, 165]
token_estimate: 1050
content_sha256: "d7f453c9faea089ff7ef262bda3e7776873b5cb07deaf38240e259dfec1fff1f"
compacted: false
heading_path: []
symbol: null
address: null
asset_path: null
---

//! CLI integration tests - end-to-end testing of llmx commands.
//!
//! These tests spawn the actual llmx binary and verify its output.

use assert_cmd::Command;
use predicates::prelude::*;
use std::fs;
use tempfile::TempDir;

/// Get a Command for the llmx binary.
fn llmx() -> Command {
    Command::cargo_bin("llmx").expect("Failed to find llmx binary")
}

/// Create a test project with sample files.
fn create_test_project() -> TempDir {
    let temp = TempDir::new().expect("Failed to create temp dir");

    fs::create_dir_all(temp.path().join("src")).unwrap();

    fs::write(
        temp.path().join("src/main.rs"),
        r#"fn main() {
    println!("Hello, world!");
}
"#,
    )
    .unwrap();

    fs::write(
        temp.path().join("src/lib.rs"),
        r#"pub fn greet(name: &str) -> String {
    format!("Hello, {}!", name)
}
"#,
    )
    .unwrap();

    fs::write(
        temp.path().join("README.md"),
        "# Test Project\n\nA simple test.\n",
    )
    .unwrap();

    temp
}

// ============================================================================
// Index Command Tests
// ============================================================================

#[test]
fn test_cli_index_directory() {
    let storage = TempDir::new().unwrap();
    let project = create_test_project();

    llmx()
        .args([
            "index",
            project.path().to_str().unwrap(),
            "--storage-dir",
            storage.path().to_str().unwrap(),
        ])
        .assert()
        .success()
        .stdout(predicate::str::contains("Created new index"))
        .stdout(predicate::str::contains("files"))
        .stdout(predicate::str::contains("chunks"));
}

#[test]
fn test_cli_index_json_output() {
    let storage = TempDir::new().unwrap();
    let project = create_test_project();

    llmx()
        .args([
            "index",
            project.path().to_str().unwrap(),
            "--storage-dir",
            storage.path().to_str().unwrap(),
            "--json",
        ])
        .assert()
        .success()
        .stdout(predicate::str::contains("\"index_id\""))
        .stdout(predicate::str::contains("\"created\": true"))  // JSON with spaces
        .stdout(predicate::str::contains("\"total_files\""));
}

#[test]
fn test_cli_index_nonexistent_path() {
    let storage = TempDir::new().unwrap();

    // Note: llmx index succeeds with nonexistent paths but creates empty index
    // This is the current behavior - it doesn't fail on missing paths
    llmx()
        .args([
            "index",
            "/nonexistent/path/that/does/not/exist",
            "--storage-dir",
            storage.path().to_str().unwrap(),
        ])
        .assert()
        .success()
        .stdout(predicate::str::contains("0 files"));
}

#[test]
fn test_cli_index_empty_directory() {
    let storage = TempDir::new().unwrap();
    let empty_dir = TempDir::new().unwrap();

    llmx()
        .args([
            "index",
            empty_dir.path().to_str().unwrap(),
            "--storage-dir",
            storage.path().to_str().unwrap(),
        ])
        .assert()
        .success()
        .stdout(predicate::str::contains("0 files"));
}

#[test]
fn test_cli_index_with_options() {
    let storage = TempDir::new().unwrap();
    let project = create_test_project();

    llmx()
        .args([
            "index",
            project.path().to_str().unwrap(),
            "--storage-dir",
            storage.path().to_str().unwrap(),
            "--chunk-size",
            "2000",
            "--max-file",
            "5000000",
        ])
        .assert()
        .success();
}

// ============================================================================
// Search Command Tests
// ============================================================================

#[test]
fn test_cli_search_basic() {
    let storage = TempDir::new().unwrap();
    let project = create_test_project();

    // Index first
    llmx()
        .args([
            "index",
            project.path().to_str().unwrap(),
            "--storage-dir",
            storage.path().to_str().unwrap(),
        ])
        .assert()
        .success();