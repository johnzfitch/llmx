---
chunk_index: 1055
ref: "34db4ab795ac"
id: "34db4ab795aca56240c543eab6e000f2f4b0b67bbfbec9be03abfd5671ee0498"
slug: "baseline-l137-266"
path: "/home/zack/dev/llmx/ingestor-core/benches/baseline.rs"
kind: "text"
lines: [137, 266]
token_estimate: 1031
content_sha256: "c811a11942fe2aea88d18a15c0b71623b6e38afd70088f7b315443e226b89d6d"
compacted: false
heading_path: []
symbol: null
address: null
asset_path: null
---

group.finish();
}

// Benchmark: Memory usage (serialize/deserialize)
fn bench_serialization(c: &mut Criterion) {
    let mut group = c.benchmark_group("serialization");

    let index = create_test_index(50, 2);

    group.bench_function("serialize_index", |b| {
        b.iter(|| {
            black_box(serde_json::to_vec(&index).unwrap())
        });
    });

    let serialized = serde_json::to_vec(&index).unwrap();
    group.bench_function("deserialize_index", |b| {
        b.iter(|| {
            black_box(serde_json::from_slice::<IndexFile>(&serialized).unwrap())
        });
    });

    group.finish();
}

// Phase 5: Embedding generation benchmarks
#[cfg(feature = "embeddings")]
fn bench_embedding_generation(c: &mut Criterion) {
    let mut group = c.benchmark_group("embedding_generation");

    let short_text = "function hello() { return 'world'; }";
    let medium_text = "// Complex function\nfunction processData(items) {\n  return items.map(item => {\n    return transform(item);\n  }).filter(x => x != null);\n}";
    let long_text = format!("{}\n{}", medium_text.repeat(5), short_text.repeat(10));

    group.bench_function("generate_single_short", |b| {
        b.iter(|| black_box(generate_embedding(short_text)));
    });

    group.bench_function("generate_single_medium", |b| {
        b.iter(|| black_box(generate_embedding(medium_text)));
    });

    group.bench_function("generate_single_long", |b| {
        b.iter(|| black_box(generate_embedding(&long_text)));
    });

    let chunk_texts: Vec<&str> = (0..100).map(|_| short_text).collect();
    group.bench_function("generate_batch_100", |b| {
        b.iter(|| black_box(generate_embeddings(&chunk_texts)));
    });

    group.finish();
}

// Phase 5: Vector search benchmarks
#[cfg(feature = "embeddings")]
fn bench_vector_search(c: &mut Criterion) {
    let mut group = c.benchmark_group("vector_search");

    let mut index = create_test_index(50, 2);

    // Generate embeddings
    let chunk_texts: Vec<&str> = index.chunks.iter().map(|c| c.content.as_str()).collect();
    let embeddings = generate_embeddings(&chunk_texts);
    let query_embedding = generate_embedding("function test");

    group.bench_function("vector_search_50chunks", |b| {
        b.iter(|| {
            black_box(vector_search(
                &index.chunks,
                &index.chunk_refs,
                &embeddings,
                &query_embedding,
                &SearchFilters::default(),
                10,
            ))
        });
    });

    group.finish();
}

// Phase 5: Hybrid search benchmarks
#[cfg(feature = "embeddings")]
fn bench_hybrid_search(c: &mut Criterion) {
    let mut group = c.benchmark_group("hybrid_search");

    let mut index = create_test_index(50, 2);

    // Generate embeddings
    let chunk_texts: Vec<&str> = index.chunks.iter().map(|c| c.content.as_str()).collect();
    let embeddings = generate_embeddings(&chunk_texts);

    for query in ["function", "test println", "error handling"] {
        let query_embedding = generate_embedding(query);
        group.bench_with_input(
            BenchmarkId::from_parameter(query),
            &(query, &query_embedding),
            |b, (q, qe)| {
                b.iter(|| {
                    black_box(hybrid_search(
                        &index.chunks,
                        &index.inverted_index,
                        &index.chunk_refs,
                        &embeddings,
                        q,
                        qe,
                        &SearchFilters::default(),
                        10,
                    ))
                });
            },
        );
    }

    group.finish();
}

// Phase 5: Cosine similarity benchmarks
#[cfg(feature = "embeddings")]
fn bench_cosine_similarity(c: &mut Criterion) {
    let mut group = c.benchmark_group("cosine_similarity");

    let embedding1 = generate_embedding("function test");
    let embedding2 = generate_embedding("function hello");

    group.bench_function("cosine_similarity_384dim", |b| {
        b.iter(|| black_box(cosine_similarity(&embedding1, &embedding2)));
    });