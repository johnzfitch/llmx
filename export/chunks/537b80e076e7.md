---
chunk_index: 1082
ref: "537b80e076e7"
id: "537b80e076e71cfe105fcc9cc91f526c124a22607639c3961aa26a2642faaf01"
slug: "index-l281-329"
path: "/home/zack/dev/llmx/ingestor-core/src/index.rs"
kind: "text"
lines: [281, 329]
token_estimate: 428
content_sha256: "4b54f82b4a0cf564d3e1dc3a2501ca33172a81b511aae41f739fad369de6182d"
compacted: false
heading_path: []
symbol: null
address: null
asset_path: null
---

let mut semantic_map: HashMap<String, f32> = HashMap::new();
    for result in &semantic_results {
        semantic_map.insert(result.chunk_id.clone(), result.score);
    }

    let mut all_chunk_ids: HashSet<String> = HashSet::new();
    for result in &bm25_results {
        all_chunk_ids.insert(result.chunk_id.clone());
    }
    for result in &semantic_results {
        all_chunk_ids.insert(result.chunk_id.clone());
    }

    let mut hybrid_results: Vec<SearchResult> = Vec::new();

    for chunk_id in all_chunk_ids {
        let bm25_score = bm25_map.get(&chunk_id).copied().unwrap_or(0.0);
        let semantic_score = semantic_map.get(&chunk_id).copied().unwrap_or(0.0);

        let normalized_bm25 = if max_bm25 > 0.0 {
            bm25_score / max_bm25
        } else {
            0.0
        };

        let final_score = 0.5 * normalized_bm25 + 0.5 * semantic_score;

        if let Some(chunk) = chunks.iter().find(|c| c.id == chunk_id) {
            let chunk_ref = chunk_refs
                .get(chunk_id.as_str())
                .cloned()
                .unwrap_or_else(|| chunk.short_id.clone());
            hybrid_results.push(SearchResult {
                chunk_id: chunk_id.clone(),
                chunk_ref,
                score: final_score,
                path: chunk.path.clone(),
                start_line: chunk.start_line,
                end_line: chunk.end_line,
                snippet: snippet(&chunk.content, 200),
                heading_path: chunk.heading_path.clone(),
            });
        }
    }

    hybrid_results.sort_by(|a, b| b.score.partial_cmp(&a.score).unwrap_or(std::cmp::Ordering::Equal));
    hybrid_results.truncate(limit);
    hybrid_results
}