---
chunk_index: 646
ref: "41b4ce896766"
id: "41b4ce8967668a6c7868f030d39671feeb2ec1aaa08ae1940215042e9195eb87"
slug: "phase-5-completion-report--search-handler-src-mcp-tools-rs-284-317"
path: "/home/zack/dev/llmx/docs/PHASE_5_COMPLETION_REPORT.md"
kind: "markdown"
lines: [135, 162]
token_estimate: 218
content_sha256: "e99aa6478042d5a735f933a089c9163ca4a555a585e0b7d6ee5b532cd84ba4ef"
compacted: false
heading_path: ["Phase 5 Completion Report: Semantic Search Integration","Implementation Summary","4. Integration Points","Search Handler (src/mcp/tools.rs:284-317)"]
symbol: null
address: null
asset_path: null
---

#### Search Handler (src/mcp/tools.rs:284-317)
```rust
let search_results = if input.use_semantic.unwrap_or(false) {
    #[cfg(feature = "embeddings")]
    {
        if let Some(embeddings) = &index.embeddings {
            let query_embedding = generate_embedding(&input.query);
            hybrid_search(...)
        } else {
            // Fall back to BM25
            search(index, &input.query, filters.clone(), limit * 2)
        }
    }
    #[cfg(not(feature = "embeddings"))]
    {
        search(index, &input.query, filters.clone(), limit * 2)
    }
} else {
    // Standard BM25 search (default)
    search(index, &input.query, filters, limit * 2)
};
```

- Default: BM25-only (backward compatible)
- When `use_semantic: true`: Hybrid search if embeddings available
- Graceful fallback: BM25 if embeddings missing
- Token budgeting: Still applied after ranking