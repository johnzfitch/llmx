---
chunk_index: 1103
ref: "ac68812df3b9"
id: "ac68812df3b93595ce5b28744af2f52da5a2db7e3b1a4cd714077d23f3c9ea6f"
slug: "edge-cases-tests-l137-278"
path: "/home/zack/dev/llmx/ingestor-core/tests/edge_cases_tests.rs"
kind: "text"
lines: [137, 278]
token_estimate: 1012
content_sha256: "02e9546ae02860cb44ce77d09a5e6a6d1af28ea7f54f8d94316c33bb4baf96bd"
compacted: false
heading_path: []
symbol: null
address: null
asset_path: null
---

let index = ingest_files(vec![input], IngestOptions::default());
    assert_eq!(index.files.len(), 1);
    assert!(!index.chunks.is_empty());
}

#[test]
fn test_binary_file_rejection() {
    let input = FileInput {
        path: "binary.bin".to_string(),
        data: vec![0x00, 0x01, 0x02, 0xFF, 0xFE, 0xFD],
        mtime_ms: None,
        fingerprint_sha256: None,
    };

    let index = ingest_files(vec![input], IngestOptions::default());
    // Binary files without recognized extensions are skipped
    assert!(index.files.is_empty());
}

#[test]
fn test_file_with_null_bytes() {
    let mut data = b"fn test() { }".to_vec();
    data.push(0x00);
    data.extend_from_slice(b" more content");

    let input = FileInput {
        path: "with_null.rs".to_string(),
        data,
        mtime_ms: None,
        fingerprint_sha256: None,
    };

    let index = ingest_files(vec![input], IngestOptions::default());
    // Should handle null bytes gracefully
    assert!(!index.files.is_empty() || !index.warnings.is_empty());
}

#[test]
fn test_very_long_lines() {
    let long_line = "x".repeat(10000);
    let content = format!("// Comment\n{}\n// End", long_line);

    let input = FileInput {
        path: "long_lines.rs".to_string(),
        data: content.into_bytes(),
        mtime_ms: None,
        fingerprint_sha256: None,
    };

    let index = ingest_files(vec![input], IngestOptions::default());
    assert_eq!(index.files.len(), 1);
}

#[test]
fn test_mixed_line_endings() {
    // Mix of \n, \r\n, and \r
    let content = "line1\nline2\r\nline3\rline4";

    let input = FileInput {
        path: "mixed_endings.rs".to_string(),
        data: content.as_bytes().to_vec(),
        mtime_ms: None,
        fingerprint_sha256: None,
    };

    let index = ingest_files(vec![input], IngestOptions::default());
    assert_eq!(index.files.len(), 1);
}

#[test]
fn test_utf8_bom() {
    // UTF-8 BOM followed by content
    let mut content = vec![0xEF, 0xBB, 0xBF];
    content.extend_from_slice(b"fn main() {}");

    let input = FileInput {
        path: "with_bom.rs".to_string(),
        data: content,
        mtime_ms: None,
        fingerprint_sha256: None,
    };

    let index = ingest_files(vec![input], IngestOptions::default());
    assert_eq!(index.files.len(), 1);
}

#[test]
fn test_file_without_newline_at_end() {
    let content = "fn main() { println!(\"no newline\"); }"; // No trailing newline

    let input = FileInput {
        path: "no_newline.rs".to_string(),
        data: content.as_bytes().to_vec(),
        mtime_ms: None,
        fingerprint_sha256: None,
    };

    let index = ingest_files(vec![input], IngestOptions::default());
    assert_eq!(index.files.len(), 1);
    // Content should be preserved
    assert!(index.chunks[0].content.contains("no newline"));
}

// ============================================================================
// Index Edge Cases
// ============================================================================

#[test]
fn test_index_with_zero_chunks() {
    // Index with only empty files
    let input = FileInput {
        path: "empty.txt".to_string(),
        data: vec![],
        mtime_ms: None,
        fingerprint_sha256: None,
    };

    let index = ingest_files(vec![input], IngestOptions::default());
    // Should have file metadata even if no content chunks
    assert!(index.files.len() <= 1);
}

#[test]
fn test_index_many_small_files() {
    let inputs: Vec<FileInput> = (0..100)
        .map(|i| FileInput {
            path: format!("file{}.rs", i),
            data: format!("fn f{}() {{}}", i).into_bytes(),
            mtime_ms: None,
            fingerprint_sha256: None,
        })
        .collect();

    let index = ingest_files(inputs, IngestOptions::default());
    assert_eq!(index.files.len(), 100);
    assert!(index.chunks.len() >= 100);
}

// ============================================================================
// Search Edge Cases
// ============================================================================