---
chunk_index: 1332
ref: "e99d2ac3367a"
id: "e99d2ac3367aaa520de79f557a97288683a4bbd9821dd4dec9f584e312834d60"
slug: "app--createlocalbackend"
path: "/home/zack/dev/llmx/web/app.js"
kind: "java_script"
lines: [148, 223]
token_estimate: 772
content_sha256: "0c7cd1d9958f53819934ad222d135bbc6ee1862f202b79946a0ba679359ae650"
compacted: false
heading_path: []
symbol: "createLocalBackend"
address: null
asset_path: null
---

async function createLocalBackend() {
  const wasmModule = await import("./pkg/ingestor_wasm.js");
  await wasmModule.default();
  const WasmIngestor = wasmModule.Ingestor;
  let ingestor = null;

  return {
    kind: "local",
    async call(op, payload) {
      switch (op) {
        case "ping":
          return { ready: true };
        case "ingest": {
          const files = (payload.files || []).map((file) => ({
            path: file.path,
            data: new Uint8Array(file.data),
            mtime_ms: file.mtime_ms ?? null,
            fingerprint_sha256: file.fingerprint_sha256 ?? null,
          }));
          ingestor = WasmIngestor.ingest(files, null);
          return { indexId: ingestor.indexId() };
        }
        case "updateSelective": {
          if (!ingestor) throw new Error("No index loaded");
          const files = (payload.files || []).map((file) => ({
            path: file.path,
            data: new Uint8Array(file.data),
            mtime_ms: file.mtime_ms ?? null,
            fingerprint_sha256: file.fingerprint_sha256 ?? null,
          }));
          await ingestor.updateSelective(files, payload.keepPaths || [], null);
          return { updated: true };
        }
        case "loadIndexJson":
          ingestor = WasmIngestor.fromIndexJson(payload.json);
          return { loaded: true };
        case "exportIndexJson":
          if (!ingestor) throw new Error("No index loaded");
          return { json: ingestor.exportIndexJson() };
        case "stats":
          if (!ingestor) throw new Error("No index loaded");
          return { stats: await ingestor.stats() };
        case "warnings":
          if (!ingestor) throw new Error("No index loaded");
          return { warnings: await ingestor.warnings() };
        case "search":
          if (!ingestor) throw new Error("No index loaded");
          return { results: await ingestor.search(payload.query, payload.filters, payload.limit) };
        case "getChunk":
          if (!ingestor) throw new Error("No index loaded");
          return { chunk: await ingestor.getChunk(payload.chunkId) };
        case "listOutline":
          if (!ingestor) throw new Error("No index loaded");
          return { outline: await ingestor.listOutline(payload.path) };
        case "listSymbols":
          if (!ingestor) throw new Error("No index loaded");
          return { symbols: await ingestor.listSymbols(payload.path) };
        case "exportLlm":
          if (!ingestor) throw new Error("No index loaded");
          return { content: ingestor.exportLlm() };
        case "exportZip":
          if (!ingestor) throw new Error("No index loaded");
          return { bytes: ingestor.exportZip() };
        case "files":
          if (!ingestor) throw new Error("No index loaded");
          return { files: await ingestor.files() };
        case "indexId":
          if (!ingestor) throw new Error("No index loaded");
          return { indexId: ingestor.indexId() };
        default:
          throw new Error(`Unknown op: ${op}`);
      }
    },
    terminate() {},
  };
}