---
chunk_index: 1331
ref: "d26b3970e31c"
id: "d26b3970e31c09f7ca202dbb4fdaa3d7b0414c8b8c09a9f514d0ba267e69cf39"
slug: "app--createworkerbackend"
path: "/home/zack/dev/llmx/web/app.js"
kind: "java_script"
lines: [106, 146]
token_estimate: 302
content_sha256: "dc6f983f3247e3062728fdb817a38030f4c589180df28ed4822f781c9ec03450"
compacted: false
heading_path: []
symbol: "createWorkerBackend"
address: null
asset_path: null
---

function createWorkerBackend() {
  const worker = new Worker(new URL("./worker.js", import.meta.url), { type: "module" });
  worker.onmessage = (event) => {
    const msg = event.data || {};
    const pending = pendingCalls.get(msg.id);
    if (!pending) {
      return;
    }
    pendingCalls.delete(msg.id);
    if (msg.ok) {
      pending.resolve(msg.data);
    } else {
      pending.reject(new Error(msg.error || "Worker error"));
    }
  };
  worker.onerror = (event) => {
    const message = event?.message ? `Worker error: ${event.message}` : "Worker error";
    rejectAllPendingWorkerCalls(message);
    setStatus(message);
  };
  worker.onmessageerror = () => {
    const message = "Worker message error (structured clone failed).";
    rejectAllPendingWorkerCalls(message);
    setStatus(message);
  };

  return {
    kind: "worker",
    call(op, payload, transfer) {
      const id = ++workerCallId;
      return new Promise((resolve, reject) => {
        pendingCalls.set(id, { resolve, reject });
        worker.postMessage({ id, op, payload }, transfer || []);
      });
    },
    terminate() {
      rejectAllPendingWorkerCalls("Worker terminated.");
      worker.terminate();
    },
  };
}