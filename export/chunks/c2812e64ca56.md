---
chunk_index: 1054
ref: "c2812e64ca56"
id: "c2812e64ca563914bd827e234a14481f63fb849bb09a04c936b472a06efbb28d"
slug: "baseline-l1-136"
path: "/home/zack/dev/llmx/ingestor-core/benches/baseline.rs"
kind: "text"
lines: [1, 136]
token_estimate: 1039
content_sha256: "5dfb0b03a605505c64c27405e89b65a1ab5424654dd0342bd61b61156c56bae3"
compacted: false
heading_path: []
symbol: null
address: null
asset_path: null
---

use criterion::{black_box, criterion_group, criterion_main, Criterion, BenchmarkId};
use ingestor_core::{
    ingest_files, search, build_inverted_index, compute_stats, FileInput, IngestOptions,
    SearchFilters, IndexFile,
};

#[cfg(feature = "embeddings")]
use ingestor_core::{
    embeddings::{generate_embedding, generate_embeddings, cosine_similarity},
    hybrid_search, vector_search,
};

// Test data generators
fn create_test_file(path: &str, size_kb: usize) -> FileInput {
    let content = format!("// Test file: {}\n{}", path, "fn test() { println!(\"hello\"); }\n".repeat(size_kb * 10));
    FileInput {
        path: path.to_string(),
        data: content.into_bytes(),
        mtime_ms: Some(1234567890),
        fingerprint_sha256: None,
    }
}

fn create_test_index(file_count: usize, file_size_kb: usize) -> IndexFile {
    let files: Vec<FileInput> = (0..file_count)
        .map(|i| create_test_file(&format!("src/file_{}.rs", i), file_size_kb))
        .collect();

    let options = IngestOptions {
        chunk_target_chars: 4000,
        chunk_max_chars: 8000,
        max_file_bytes: 10 * 1024 * 1024,
        max_total_bytes: 50 * 1024 * 1024,
        max_chunks_per_file: 2000,
    };

    ingest_files(files, options)
}

// Benchmark: Index creation
fn bench_index_creation(c: &mut Criterion) {
    let mut group = c.benchmark_group("index_creation");

    for (file_count, file_size_kb) in [(10, 1), (50, 2), (100, 5)] {
        group.bench_with_input(
            BenchmarkId::from_parameter(format!("{}files_{}kb", file_count, file_size_kb)),
            &(file_count, file_size_kb),
            |b, &(fc, fs)| {
                b.iter(|| {
                    let files: Vec<FileInput> = (0..fc)
                        .map(|i| create_test_file(&format!("src/file_{}.rs", i), fs))
                        .collect();

                    let options = IngestOptions {
                        chunk_target_chars: 4000,
                        chunk_max_chars: 8000,
                        max_file_bytes: 10 * 1024 * 1024,
                        max_total_bytes: 50 * 1024 * 1024,
                        max_chunks_per_file: 2000,
                    };

                    black_box(ingest_files(files, options))
                });
            },
        );
    }

    group.finish();
}

// Benchmark: BM25 search
fn bench_search_bm25(c: &mut Criterion) {
    let mut group = c.benchmark_group("search_bm25");

    // Pre-create index
    let index = create_test_index(50, 2);

    for query in ["function", "test println", "hello world"] {
        group.bench_with_input(
            BenchmarkId::from_parameter(query),
            &query,
            |b, q| {
                b.iter(|| {
                    black_box(search(
                        &index,
                        q,
                        SearchFilters::default(),
                        10,
                    ))
                });
            },
        );
    }

    group.finish();
}

// Benchmark: Inverted index build
fn bench_inverted_index_build(c: &mut Criterion) {
    let mut group = c.benchmark_group("inverted_index_build");

    for chunk_count in [100, 500, 1000] {
        let index = create_test_index(chunk_count / 10, 1);

        group.bench_with_input(
            BenchmarkId::from_parameter(format!("{}chunks", chunk_count)),
            &index.chunks,
            |b, chunks| {
                b.iter(|| {
                    black_box(build_inverted_index(chunks))
                });
            },
        );
    }

    group.finish();
}

// Benchmark: Stats computation
fn bench_stats_computation(c: &mut Criterion) {
    let mut group = c.benchmark_group("stats_computation");

    for file_count in [10, 50, 100] {
        let index = create_test_index(file_count, 2);

        group.bench_with_input(
            BenchmarkId::from_parameter(format!("{}files", file_count)),
            &(index.files.clone(), index.chunks.clone()),
            |b, (files, chunks)| {
                b.iter(|| {
                    black_box(compute_stats(files, chunks))
                });
            },
        );
    }