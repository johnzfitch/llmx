---
chunk_index: 1092
ref: "963db1bb72b0"
id: "963db1bb72b04af569cdaa3bad5a9600a22364ac3e73a892e2d3a21ca755459f"
slug: "util-l179-198"
path: "/home/zack/dev/llmx/ingestor-core/src/util.rs"
kind: "text"
lines: [179, 198]
token_estimate: 178
content_sha256: "d46ad34c11002abd8ef7cd174b71468fe089f22de385efc5af578b3be406f444"
compacted: false
heading_path: []
symbol: null
address: null
asset_path: null
---

pub fn build_chunk_refs(chunks: &[Chunk]) -> BTreeMap<String, String> {
    let mut refs = BTreeMap::new();
    let mut seen = BTreeSet::new();

    for chunk in chunks {
        let mut prefix_len = 12usize.min(chunk.id.len());
        let mut ref_str = chunk.id[..prefix_len].to_string();
        while seen.contains(&ref_str) && prefix_len < chunk.id.len() {
            prefix_len = (prefix_len + 4).min(chunk.id.len());
            ref_str = chunk.id[..prefix_len].to_string();
        }
        if seen.contains(&ref_str) {
            ref_str = format!("{}-{}", chunk.id, chunk.chunk_index);
        }
        seen.insert(ref_str.clone());
        refs.insert(chunk.id.clone(), ref_str);
    }

    refs
}